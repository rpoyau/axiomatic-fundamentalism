name: Zenodo Deposit (Auto + Preview + DOI Reuse)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      preview:
        description: 'Create draft on Zenodo sandbox (true = preview, false = publish)'
        required: true
        default: 'false'
        type: boolean

jobs:
  zenodo:
    runs-on: ubuntu-latest
    permissions:
      contents: write # NOTE: Changed from 'read' to 'write' so the last step can push the DOI file.
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Required for the last step to push the .zenodo_doi file
          token: ${{ secrets.GITHUB_TOKEN }} 
          fetch-depth: 0 # Fetch all history for proper tag/release info

      - name: Set tag & repo info
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            # For manual dispatch, use the latest main commit SHA as a safe default TAG
            echo "TAG=${{ github.sha }}" >> $GITHUB_ENV 
          fi
          
          FULL_REPO_NAME="${{ github.repository }}"
          echo "REPO_NAME=${FULL_REPO_NAME##*/}" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/${{ github.repository }}" >> $GITHUB_ENV
          
          # Define the standard name we expect the PDF to be saved as
          echo "PDF_ARTIFACT_NAME=axiomatic-fundamentalism-artifact" >> $GITHUB_ENV
          echo "PDF_FILE_NAME=${{ env.REPO_NAME }}-${{ env.TAG }}.pdf" >> $GITHUB_ENV

      # NEW STEP: Download the PDF artifact created by the build workflow.
      # This assumes the build-pdf.yml workflow has already run and uploaded the artifact.
      - name: Download PDF Artifact
        uses: actions/download-artifact@v4
        with:
          # Download the artifact by the standardized name
          name: ${{ env.PDF_ARTIFACT_NAME }}
          path: ./

      - name: Find and Rename PDF for Zenodo
        id: pdf
        run: |
          # The artifact download results in a directory with the artifact's original name.
          # We need to find the PDF inside that directory.
          FOUND_PDF=$(find ${{ env.PDF_ARTIFACT_NAME }} -type f -name "*.pdf" -print -quit)
          
          if [[ -z "$FOUND_PDF" ]]; then
            echo "No PDF found inside the downloaded artifact directory." >&2
            exit 1
          fi

          # Rename and move the found PDF to the root using the standardized release name
          # This ensures the zipped filename is consistent for Zenodo.
          RELEASE_PDF_NAME="${{ env.REPO_NAME }}-${{ env.TAG }}.pdf"
          cp "$FOUND_PDF" "$RELEASE_PDF_NAME"
          
          echo "path=$RELEASE_PDF_NAME" >> $GITHUB_OUTPUT
          echo "name=$RELEASE_PDF_NAME" >> $GITHUB_OUTPUT

      - name: Render .zenodo.json
        run: |
          # Substitutes ${TAG} and ${REPO_URL} variables into the .zenodo.json file
          envsubst < .zenodo.json > .zenodo.rendered.json
          mv .zenodo.rendered.json .zenodo.json

      - name: Load existing DOI (if any)
        id: doi
        run: |
          DOI_FILE=".zenodo_doi"
          if [[ -f "$DOI_FILE" ]]; then
            DOI=$(cat "$DOI_FILE")
            echo "Using existing DOI: $DOI"
            echo "doi=$DOI" >> $GITHUB_OUTPUT
          else
            echo "No existing DOI â†’ new deposit"
          fi

      - name: Create bundle
        run: |
          # Zips the rendered metadata and the standardized PDF file
          zip release-bundle.zip \
            "${{ steps.pdf.outputs.path }}" \
            .zenodo.json

      - name: Upload to Zenodo
        id: upload
        uses: zenodraft/action@0.13.3
        with:
          deposit_id: ""
          sandbox: ${{ inputs.preview || false }}
          token: ${{ secrets.ZENODO_TOKEN }}
          files: release-bundle.zip

      - name: Save DOI after first publish
        if: ${{ !inputs.preview && !env.doi }}
        run: |
          DOI=$(jq -r .doi .zenodo.json.response.json || echo "")
          if [[ "$DOI" =~ ^10\.5281/zenodo\.[0-9]+ ]]; then
            echo "$DOI" > .zenodo_doi
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add .zenodo_doi
            git commit -m "chore: save Zenodo DOI $DOI"
            git push
            echo "DOI saved: $DOI"
          fi

      - name: Show result
        run: |
          if ${{ inputs.preview }}; then
            echo "Preview: https://sandbox.zenodo.org/deposit/${{ steps.upload.outputs.deposit_id }}"
          else
            echo "Published: https://zenodo.org/record/${{ steps.upload.outputs.deposit_id }}"
          fi